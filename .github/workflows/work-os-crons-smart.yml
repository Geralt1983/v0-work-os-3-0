name: Work-OS Scheduled Notifications

on:
  schedule:
    # Run every hour on weekdays from 12-23 UTC (covers 7am-7pm EST/EDT range)
    # The endpoint will determine if it's actually time to send
    - cron: '0 12-23 * * 1-5'
    
    # Sunday evening for weekly review (run at both possible UTC times)
    - cron: '0 22,23 * * 0'

  # Allow manual triggers for testing
  workflow_dispatch:
    inputs:
      notification_type:
        description: 'Which notification to trigger'
        required: true
        default: 'test'
        type: choice
        options:
          - morning
          - started-check
          - afternoon
          - end-of-day
          - weekly-review
          - test

jobs:
  scheduled-notification:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    
    steps:
      - name: Manual Dispatch Handler
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "Manual trigger: ${{ github.event.inputs.notification_type }}"
          
          case "${{ github.event.inputs.notification_type }}" in
            morning)
              curl -s -X GET "${{ secrets.WORKOS_API_URL }}/api/notifications/morning-summary" \
                -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"
              ;;
            started-check)
              curl -s -X GET "${{ secrets.WORKOS_API_URL }}/api/notifications/started-check" \
                -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"
              ;;
            afternoon)
              curl -s -X GET "${{ secrets.WORKOS_API_URL }}/api/notifications/afternoon-summary" \
                -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"
              ;;
            end-of-day)
              curl -s -X GET "${{ secrets.WORKOS_API_URL }}/api/notifications/end-of-day" \
                -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"
              ;;
            weekly-review)
              curl -s -X GET "${{ secrets.WORKOS_API_URL }}/api/notifications/weekly-backlog-review" \
                -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}"
              ;;
            test)
              curl -s -X POST "${{ secrets.WORKOS_API_URL }}/api/notifications/test" \
                -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
                -H "Content-Type: application/json" \
                -d '{"message": "ðŸ§ª GitHub Actions test - crons are working!"}'
              ;;
          esac

      - name: Scheduled Dispatcher (DST-aware)
        if: github.event_name == 'schedule'
        run: |
          # Call the smart dispatcher endpoint - it knows EST/EDT and decides what to send
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.WORKOS_API_URL }}/api/cron/dispatcher" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "Response: $body"
          echo "HTTP Code: $http_code"
          
          if [ "$http_code" -ge 500 ]; then
            echo "::error::Dispatcher failed with HTTP $http_code"
            exit 1
          fi
